# This workflow uses Debricked (OpenText Core SCA) for vulnerability scanning
# Debricked documentation: https://docs.debricked.com/
on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  security-events: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Debricked Scan
        uses: debricked/actions/scan@v1.4.0
        with:
          token: ${{ secrets.DEBRICKED_TOKEN }}
        uses: actions/checkout@v4

      - name: Install Debricked CLI
        run: |
          set -euo pipefail

          # Pin to a specific version for supply-chain security (avoid mutable `latest`)
          CLI_VERSION="2.0.0" # TODO: bump intentionally as part of dependency maintenance
          curl --fail --location --silent --show-error \
            "https://github.com/debricked/cli/releases/download/v${CLI_VERSION}/cli_linux_x86_64.tar.gz" \
            | tar -xz

          sudo mv debricked /usr/local/bin/
          debricked --version

      - name: Run Debricked Scan
        env:
          # Secret is read from GitHub Actions secrets context
          DEBRICKED_TOKEN: ${{ secrets.DEBRICKED_TOKEN }}
        run: |
          debricked scan -t $DEBRICKED_TOKEN -r ${{ github.repository }} -c ${{ github.sha }}
