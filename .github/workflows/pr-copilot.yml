name: PR Copilot Agent

# Comprehensive PR management, maintenance, and completion workflows
# Triggered by PR mentions, labels, events, and status checks

on:
  pull_request:
    types: [opened, labeled, synchronize]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]
  check_suite:
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: read
  statuses: read

jobs:
  # Job 1: Detect what triggered the agent and set context
  detect-trigger:
    name: Detect Trigger
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request) ||
      github.event_name == 'pull_request' ||
      github.event_name == 'pull_request_review' ||
      github.event_name == 'pull_request_review_comment' ||
      github.event_name == 'check_suite'
    outputs:
      trigger_type: ${{ steps.detect.outputs.trigger_type }}
      pr_number: ${{ steps.detect.outputs.pr_number }}
      should_welcome: ${{ steps.detect.outputs.should_welcome }}
      should_check_scope: ${{ steps.detect.outputs.should_check_scope }}
      should_status_update: ${{ steps.detect.outputs.should_status_update }}
      should_handle_review: ${{ steps.detect.outputs.should_handle_review }}
      should_check_automerge: ${{ steps.detect.outputs.should_check_automerge }}
      should_check_conflicts: ${{ steps.detect.outputs.should_check_conflicts }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Detect trigger type and set flags
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;
            let triggerType = 'unknown';
            let prNumber = null;
            let shouldWelcome = false;
            let shouldCheckScope = false;
            let shouldStatusUpdate = false;
            let shouldHandleReview = false;
            let shouldCheckAutomerge = false;
            let shouldCheckConflicts = false;
            
            // Determine PR number based on event type
            if (eventName === 'issue_comment') {
              prNumber = context.issue.number;
            } else if (eventName === 'pull_request' || eventName === 'pull_request_review' || eventName === 'pull_request_review_comment') {
              prNumber = context.payload.pull_request.number;
            } else if (eventName === 'check_suite') {
              // Get PR number from check suite
              const { data: pulls } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${context.payload.check_suite.head_branch}`,
                state: 'open'
              });
              if (pulls.length > 0) {
                prNumber = pulls[0].number;
              }
            }
            
            // Detect trigger type and set appropriate flags
            if (eventName === 'issue_comment') {
              const comment = context.payload.comment.body.toLowerCase();
              
              if (comment.includes('@pr-copilot') || comment.includes('@pr_copilot')) {
                triggerType = 'mention';
                
                // Check for status update request
                if (comment.includes('status update') || comment.includes('progress report') || comment.includes('show status')) {
                  shouldStatusUpdate = true;
                }
                
                // Check if this is first mention - trigger welcome
                const { data: comments } = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber
                });
                
                const prCopilotComments = comments.filter(c => 
                  c.user.login === 'github-actions[bot]' && 
                  c.body.includes('PR Copilot')
                );
                
                if (prCopilotComments.length === 0) {
                  shouldWelcome = true;
                }
              }
            } else if (eventName === 'pull_request') {
              const action = context.payload.action;
              
              if (action === 'opened') {
                triggerType = 'pr_opened';
                shouldCheckScope = true;
                shouldWelcome = true;
              } else if (action === 'labeled') {
                const label = context.payload.label.name;
                if (label === 'help wanted') {
                  triggerType = 'help_wanted_label';
                  shouldWelcome = true;
                }
              } else if (action === 'synchronize') {
                triggerType = 'pr_synchronize';
                shouldCheckAutomerge = true;
                shouldCheckConflicts = true;
              }
            } else if (eventName === 'pull_request_review') {
              triggerType = 'review_submitted';
              shouldHandleReview = true;
              shouldCheckAutomerge = true;
            } else if (eventName === 'pull_request_review_comment') {
              triggerType = 'review_comment';
              shouldHandleReview = true;
            } else if (eventName === 'check_suite') {
              if (context.payload.check_suite.conclusion === 'success') {
                triggerType = 'checks_completed';
                shouldCheckAutomerge = true;
              }
            }
            
            // Set outputs
            core.setOutput('trigger_type', triggerType);
            core.setOutput('pr_number', prNumber ? prNumber.toString() : '');
            core.setOutput('should_welcome', shouldWelcome.toString());
            core.setOutput('should_check_scope', shouldCheckScope.toString());
            core.setOutput('should_status_update', shouldStatusUpdate.toString());
            core.setOutput('should_handle_review', shouldHandleReview.toString());
            core.setOutput('should_check_automerge', shouldCheckAutomerge.toString());
            core.setOutput('should_check_conflicts', shouldCheckConflicts.toString());
            
            console.log(`Trigger detected: ${triggerType}, PR: ${prNumber}`);
            console.log(`Flags - Welcome: ${shouldWelcome}, Scope: ${shouldCheckScope}, Status: ${shouldStatusUpdate}, Review: ${shouldHandleReview}, Automerge: ${shouldCheckAutomerge}, Conflicts: ${shouldCheckConflicts}`);

  # Job 2: Post welcome message on first interaction
  welcome:
    name: Welcome Message
    needs: detect-trigger
    runs-on: ubuntu-latest
    if: needs.detect-trigger.outputs.should_welcome == 'true' && needs.detect-trigger.outputs.pr_number != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Read welcome message from config
        id: config
        run: |
          # Read welcome message from config file
          if [ -f .github/pr-copilot-config.yml ]; then
            # Extract welcome message (simplified - in production use yq or python)
            echo "config_exists=true" >> $GITHUB_OUTPUT
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Post welcome message
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.detect-trigger.outputs.pr_number }};
            
            const welcomeMessage = `üëã **Welcome to PR Copilot!**
            
            I'm here to help manage this PR. Here's what I can do:
            
            **Commands:**
            - \`@pr-copilot status update\` - Get detailed PR status
            - \`@pr-copilot help\` - Show available commands
            
            **Automatic Features:**
            - ‚úÖ Scope validation (warns on large/multi-purpose PRs)
            - ‚úÖ Review comment tracking
            - ‚úÖ Auto-merge when ready
            - ‚úÖ Merge conflict detection
            
            **Status Updates:**
            I'll automatically update you on:
            - Review approvals/changes
            - Check completions
            - Merge readiness
            
            Tag me anytime with \`@pr-copilot\` for assistance!`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: welcomeMessage
            });
            
            console.log(`Welcome message posted to PR #${prNumber}`);

  # Job 3: Check PR scope and title
  scope-check:
    name: PR Scope Check
    needs: detect-trigger
    runs-on: ubuntu-latest
    if: needs.detect-trigger.outputs.should_check_scope == 'true' && needs.detect-trigger.outputs.pr_number != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Analyze PR scope
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.detect-trigger.outputs.pr_number }};
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const title = pr.title;
            const titleLength = title.length;
            const maxLength = 72;
            
            // Check for multiple change indicators
            const multipleChangeKeywords = [' and ', ' & ', ' or ', ', '];
            const hasMultipleChanges = multipleChangeKeywords.some(keyword => 
              title.toLowerCase().includes(keyword)
            );
            
            let shouldWarn = false;
            let warnings = [];
            
            if (titleLength > maxLength) {
              shouldWarn = true;
              warnings.push(`- Title is ${titleLength} characters (recommended: <${maxLength})`);
            }
            
            if (hasMultipleChanges) {
              shouldWarn = true;
              warnings.push('- Title suggests multiple changes (contains "and", "or", "&", or commas)');
            }
            
            core.setOutput('should_warn', shouldWarn.toString());
            core.setOutput('warnings', warnings.join('\n'));
            core.setOutput('title_length', titleLength.toString());
            
            return { shouldWarn, warnings, titleLength };
      
      - name: Post scope warning if needed
        if: steps.analyze.outputs.should_warn == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.detect-trigger.outputs.pr_number }};
            const warnings = `${{ steps.analyze.outputs.warnings }}`;
            const titleLength = ${{ steps.analyze.outputs.title_length }};
            
            const warningMessage = `‚ö†Ô∏è **PR Scope Notice**
            
            This PR title suggests it may be doing multiple things. Consider splitting into separate PRs for:
            - Easier review
            - Cleaner git history
            - Faster merge cycles
            
            **Potential Issues:**
            ${warnings}
            
            If this is intentional, feel free to ignore this message. Otherwise, consider breaking this into focused PRs.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: warningMessage
            });

  # Job 4: Generate and post status update
  status-update:
    name: Status Update
    needs: detect-trigger
    runs-on: ubuntu-latest
    if: needs.detect-trigger.outputs.should_status_update == 'true' && needs.detect-trigger.outputs.pr_number != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install PyGithub pyyaml requests
      
      - name: Generate status report
        id: status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.detect-trigger.outputs.pr_number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          python .github/pr-copilot/scripts/generate_status.py
      
      - name: Post status update
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = ${{ needs.detect-trigger.outputs.pr_number }};
            
            // Read status report from file
            let statusReport = '';
            try {
              statusReport = fs.readFileSync('/tmp/pr_status_report.md', 'utf8');
            } catch (error) {
              // Fallback to basic status if script failed
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });
              
              const approvedReviews = reviews.filter(r => r.state === 'APPROVED').length;
              const changesRequestedReviews = reviews.filter(r => r.state === 'CHANGES_REQUESTED').length;
              const passedChecks = checks.check_runs.filter(c => c.conclusion === 'success').length;
              const failedChecks = checks.check_runs.filter(c => c.conclusion === 'failure').length;
              
              statusReport = `üìä **PR Status Report**
              
            **PR Information:**
            - **Author:** @${pr.user.login}
            - **Title:** ${pr.title}
            - **Commits:** ${pr.commits}
            - **Files Changed:** ${pr.changed_files}
            - **Additions:** +${pr.additions} / **Deletions:** -${pr.deletions}
            
            **Review Status:**
            - ‚úÖ Approved: ${approvedReviews}
            - üîÑ Changes Requested: ${changesRequestedReviews}
            - üìã Total Reviews: ${reviews.length}
            
            **CI/Check Status:**
            - ‚úÖ Passed: ${passedChecks}
            - ‚ùå Failed: ${failedChecks}
            - üìä Total Checks: ${checks.check_runs.length}
            
            **Merge Status:**
            - Mergeable: ${pr.mergeable ? '‚úÖ Yes' : '‚ùå No'}
            - Draft: ${pr.draft ? 'üìù Yes' : '‚úÖ No'}
            
            *Last updated: ${new Date().toISOString()}*`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: statusReport
            });

  # Job 5: Handle review comments
  review-handler:
    name: Review Comment Handler
    needs: detect-trigger
    runs-on: ubuntu-latest
    if: needs.detect-trigger.outputs.should_handle_review == 'true' && needs.detect-trigger.outputs.pr_number != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Analyze review comments
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.detect-trigger.outputs.pr_number }};
            
            // Get all reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Get review comments
            const { data: reviewComments } = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Keywords indicating actionable feedback
            const actionableKeywords = [
              'please', 'should', 'could you', 'nit', 'typo',
              'fix', 'refactor', 'change', 'update', 'add', 'remove'
            ];
            
            // Find actionable comments
            const actionableItems = [];
            
            for (const review of reviews) {
              if (review.state === 'CHANGES_REQUESTED' && review.body) {
                const body = review.body.toLowerCase();
                const hasActionable = actionableKeywords.some(keyword => body.includes(keyword));
                if (hasActionable) {
                  actionableItems.push({
                    type: 'review',
                    author: review.user.login,
                    body: review.body.substring(0, 200) // Truncate for output
                  });
                }
              }
            }
            
            for (const comment of reviewComments) {
              const body = comment.body.toLowerCase();
              const hasActionable = actionableKeywords.some(keyword => body.includes(keyword));
              if (hasActionable) {
                actionableItems.push({
                  type: 'comment',
                  author: comment.user.login,
                  body: comment.body.substring(0, 200),
                  path: comment.path
                });
              }
            }
            
            core.setOutput('actionable_count', actionableItems.length.toString());
            core.setOutput('has_actionable', (actionableItems.length > 0).toString());
            
            return actionableItems;
      
      - name: Acknowledge actionable feedback
        if: steps.analyze.outputs.has_actionable == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.detect-trigger.outputs.pr_number }};
            const count = ${{ steps.analyze.outputs.actionable_count }};
            
            const acknowledgment = `üëã **Review Feedback Received**
            
            Thank you for the review! I've identified **${count}** actionable item${count > 1 ? 's' : ''} from the feedback.
            
            These items are being tracked and can be addressed by the PR author or maintainers.
            
            Use \`@pr-copilot status update\` to see current progress.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: acknowledgment
            });

  # Job 6: Check auto-merge eligibility
  auto-merge-check:
    name: Auto-Merge Check
    needs: detect-trigger
    runs-on: ubuntu-latest
    if: needs.detect-trigger.outputs.should_check_automerge == 'true' && needs.detect-trigger.outputs.pr_number != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Evaluate merge eligibility
        id: evaluate
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.detect-trigger.outputs.pr_number }};
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            // Check conditions
            const isDraft = pr.draft;
            const isMergeable = pr.mergeable;
            const hasConflicts = pr.mergeable_state === 'dirty';
            
            const hasApproval = reviews.some(r => r.state === 'APPROVED');
            const hasChangesRequested = reviews.some(r => r.state === 'CHANGES_REQUESTED');
            
            const allChecksPassed = checks.check_runs.length > 0 && 
              checks.check_runs.every(c => 
                c.status === 'completed' && 
                (c.conclusion === 'success' || c.conclusion === 'neutral' || c.conclusion === 'skipped')
              );
            
            const isEligible = !isDraft && 
                              isMergeable && 
                              !hasConflicts && 
                              hasApproval && 
                              !hasChangesRequested && 
                              allChecksPassed;
            
            core.setOutput('is_eligible', isEligible.toString());
            core.setOutput('is_draft', isDraft.toString());
            core.setOutput('has_approval', hasApproval.toString());
            core.setOutput('all_checks_passed', allChecksPassed.toString());
            core.setOutput('has_conflicts', hasConflicts.toString());
            
            return {
              isEligible,
              isDraft,
              hasApproval,
              allChecksPassed,
              hasConflicts
            };
      
      - name: Post merge eligibility status
        if: steps.evaluate.outputs.is_eligible == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.detect-trigger.outputs.pr_number }};
            
            const message = `üöÄ **Auto-Merge Eligible**
            
            This PR meets all criteria for auto-merge:
            ‚úÖ All checks passed
            ‚úÖ Approved by reviewer(s)
            ‚úÖ No merge conflicts
            ‚úÖ Not a draft
            ‚úÖ Branch is up to date
            
            Ready to merge! A maintainer can merge this PR when ready.
            
            *Note: Auto-merge requires manual confirmation for safety.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: message
            });
      
      - name: Post merge blockers if not eligible
        if: steps.evaluate.outputs.is_eligible == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.detect-trigger.outputs.pr_number }};
            const isDraft = ${{ steps.evaluate.outputs.is_draft }};
            const hasApproval = ${{ steps.evaluate.outputs.has_approval }};
            const allChecksPassed = ${{ steps.evaluate.outputs.all_checks_passed }};
            const hasConflicts = ${{ steps.evaluate.outputs.has_conflicts }};
            
            let blockers = [];
            if (isDraft) blockers.push('- üìù PR is still a draft');
            if (!hasApproval) blockers.push('- üëÄ Needs approval from reviewer');
            if (!allChecksPassed) blockers.push('- ‚ùå Some checks are failing or pending');
            if (hasConflicts) blockers.push('- ‚ö†Ô∏è Has merge conflicts');
            
            if (blockers.length > 0) {
              const message = `‚è≥ **Merge Blockers**
              
            This PR is not yet ready to merge:
            
            ${blockers.join('\n')}
            
            Address these items to make this PR merge-ready.`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: message
              });
            }

  # Job 7: Check for merge conflicts
  merge-conflict-check:
    name: Merge Conflict Detection
    needs: detect-trigger
    runs-on: ubuntu-latest
    if: needs.detect-trigger.outputs.should_check_conflicts == 'true' && needs.detect-trigger.outputs.pr_number != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for conflicts
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.detect-trigger.outputs.pr_number }};
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const hasConflicts = pr.mergeable_state === 'dirty';
            const mergeableState = pr.mergeable_state;
            
            core.setOutput('has_conflicts', hasConflicts.toString());
            core.setOutput('mergeable_state', mergeableState);
            
            return { hasConflicts, mergeableState };
      
      - name: Notify about conflicts
        if: steps.check.outputs.has_conflicts == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.detect-trigger.outputs.pr_number }};
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const message = `‚ö†Ô∏è **Merge Conflicts Detected**
            
            This PR has merge conflicts with the base branch (\`${pr.base.ref}\`).
            
            **Resolution Steps:**
            1. Update your local branch:
               \`\`\`bash
               git checkout ${pr.head.ref}
               git pull origin ${pr.base.ref}
               \`\`\`
            2. Resolve conflicts in the affected files
            3. Commit the resolution:
               \`\`\`bash
               git add .
               git commit -m "Resolve merge conflicts"
               git push
               \`\`\`
            
            Need help? Ask \`@pr-copilot help conflicts\` for more guidance.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: message
            });
